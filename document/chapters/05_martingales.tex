% !TeX root = ../main.tex
% Add the above to each chapter to make compiling the PDF easier in some editors.

\chapter{Martingales}\label{chapter:martingales}

In this section we will introduce and discuss martingales, the namesake of our thesis. Originally referring to a system of betting strategies, martingales have evolved far beyond their gambling origins and have found profound applications in various fields, including finance, probability theory, and statistical analysis. Our formalization aims for a high level of generality while maintaining clarity and simplicity, making it easier for future formalization efforts to build upon our foundation.

\section{Fundamentals}

\begin{definition}
	Let $(F_t)_{t \in [t_0,\infty)}$ be a filtration of the measure space $M$. A stochastic process $(X_t)_{t \in [t_0,\infty)}$ taking values in a Banach space $(E, \lVert \cdot \rVert)$ is a \textit{martingale with respect to the filtration $(F_t)_{t \in [t_0,\infty)}$} if the following conditions hold
	\begin{enumerate}
	\item $(X_t)_{t \in [t_0,\infty)}$ is adapted to the filtration $(F_t)_{[t_0,\infty)}$,
	\item $X_t \in L^1(E)$ for all $t \in [t_0, \infty)$,
	\item $X_s = \mathbb{E}(X_t \;\vert\; F_s)$ $\mu$-a.e. for all $s,t \in [t_0,\infty)$ with $s \le t$.
	\end{enumerate}
	Replacing ``$=$'' in the third condition with ``$\le$'' or ``$\ge$'' gives rise to the definition of a sub- or supermartingale, respectively.
\end{definition}

Using the results we have formalized in the previous chapters, we define the following locales.

\begin{isadefinition}
{\small
\begin{lstlisting}[style=isabelle]
locale martingale = sigma_finite_adapted_process +
  assumes integrable: "$\bigwedge i. \; t_0 \le i \implies \texttt{integrable} \; M \; (X \; i)$"
      and martingale_property: "$\bigwedge i \; j. \; t_0 \le i \implies i \le j$
	  $\implies $AE$ \; x \; $in$ \; M. \; X \; i \; x = \texttt{cond\_exp} \; M \; (F \; i) \; (X \; j) \; x$"
\end{lstlisting}
}
\end{isadefinition}

\begin{remark}
 In addition to what we've discussed in the last chapter, we have introduced the locale \texttt{sigma\_finite\_adapted\_process} which combines the locale \texttt{adapted\_process} with the locale \texttt{sigma\_finite\_filtered\_measure}. Without this additional restriction, we can't use the operator \texttt{cond\_exp}. Similary, the locale \texttt{sigma\_finite\_adapted\_process\_order} places a restriction on the Banach space $(E, \lVert \cdot \rVert)$, asserting the existence of an ordering compatible with scalar multiplication. Finally, the locale \texttt{sigma\_finite\_adapted\_process\_linorder} further mandates that this ordering be total. We have also introduced locales for discrete-time and continuous-time counterparts.
\end{remark}

Any stochastic process that is both a submartingale and a supermartingale is a martingale. Conversely, every martingale is also a submartingale and a supermartingale if there exists an ordering on the Banach space $E$. In anticipation of this result, we introduce the following locales.

\begin{isadefinition}
{\small
\begin{lstlisting}[style=isabelle]
locale martingale_order = martingale $M$ $F$ $t_0$ $X$ for $M$ $F$ $t_0$
	and $X$ :: "_ $\Rightarrow$ _ $\Rightarrow$ _ :: {order_topology, ordered_real_vector}"
locale martingale_linorder = martingale $M$ $F$ $t_0$ $X$ for $M$ $F$ $t_0$
	and $X$ :: "_ $\Rightarrow$ _ $\Rightarrow$ _ :: {linorder_topology, ordered_real_vector}"
sublocale martingale_linorder $\subseteq$ martingale_order ..
\end{lstlisting}
}
\end{isadefinition}

Locales for submartingales and supermartingales are introduced similarly.

\begin{isadefinition}
{\small
\begin{lstlisting}[style=isabelle]
locale submartingale = sigma_finite_adapted_process_order +
  assumes integrable: "$\bigwedge i. \; t_0 \le i \implies \texttt{integrable} \; M \; (X \; i)$"
      and submartingale_property: "$\bigwedge i \; j. \; t_0 \le i \implies i \le j$
	  $\implies $AE$ \; x \; $in$ \; M. \; X \; i \; x \le \texttt{cond\_exp} \; M \; (F \; i) \; (X \; j) \; x$"
	  
locale submartingale_linorder = submartingale $M$ $F$ $t_0$ $X$ for $M$ $F$ $t_0$ 
	and $X$ :: "_ $\Rightarrow$ _ $\Rightarrow$ _ :: {linorder_topology}"

sublocale martingale_order $\subseteq$ submartingale using martingale_property
  by (unfold_locales) (force simp add: integrable)+
sublocale martingale_linorder $\subseteq$ submartingale_linorder ..
\end{lstlisting}
}
\end{isadefinition}

\begin{isadefinition}
{\small
\begin{lstlisting}[style=isabelle]
locale supermartingale = sigma_finite_adapted_process_order +
  assumes integrable: "$\bigwedge i. \; t_0 \le i \implies \texttt{integrable} \; M \; (X \; i)$"
      and supermartingale_property: "$\bigwedge i \; j. \; t_0 \le i \implies i \le j$
	  $\implies $AE$ \; x \; $in$ \; M. \; X \; i \; x \ge \texttt{cond\_exp} \; M \; (F \; i) \; (X \; j) \; x$"
	  
locale supermartingale_linorder = supermartingale $M$ $F$ $t_0$ $X$ for $M$ $F$ $t_0$ 
	and $X$ :: "_ $\Rightarrow$ _ $\Rightarrow$ _ :: {linorder_topology}"

sublocale martingale_order $\subseteq$ supermartingale using martingale_property
  by (unfold_locales) (force simp add: integrable)+
sublocale martingale_linorder $\subseteq$ supermartingale_linorder ..
\end{lstlisting}
}
\end{isadefinition}

As noted before, a stochastic process taking values on an ordered Banach space is a martingale, if and only if it is both a submartingale and a supermartingale. The following lemma formalizes this fact.

\begin{isalemma}
{\small
\begin{lstlisting}[style=isabelle]
lemma martingale_iff: 
  shows "$\texttt{martingale} \; M \; F \; t_0 \; X \longleftrightarrow \texttt{submartingale} \; M \; F \; t_0 \; X \; \wedge \; \texttt{supermartingale} \; M \; F \; t_0 \; X$"
proof (rule iffI)
  assume asm: "$\texttt{martingale} \; M \; F \; t_0 \; X$"
  interpret martingale_order $M$ $F$ $t_0$ $X$ by (intro martingale_order.intro asm)
  show "$\texttt{submartingale} \; M \; F \; t_0 \; X \wedge \texttt{supermartingale} \; M \; F \; t_0 \; X$" 
    using submartingale_axioms supermartingale_axioms by blast
next
  assume asm: "$\texttt{submartingale} \; M \; F \; t_0 \; X \wedge \texttt{supermartingale} \; M \; F \; t_0 \; X$"
  interpret submartingale $M$ $F$ $t_0$ $X$ by (simp add: asm)
  interpret supermartingale $M$ $F$ $t_0$ $X$ by (simp add: asm)
  show "$\texttt{martingale} \; M \; F \; t_0 \; X$" 
    using submartingale_property supermartingale_property 
    by (unfold_locales) (intro integrable, blast, force)
qed
\end{lstlisting}
}
\end{isalemma}

Additionally, we have included lemmas for introducing martingales in simple cases. For $f \in L^1(E)$ and $F_{t_0}$-measurable, the constant stochastic process defined by $X_t = f$ is a martingale. The following lemma reflects this.

\begin{isalemma}
{\small
\begin{lstlisting}[style=isabelle]
lemma (in sigma_finite_filtered_measure) martingale_const_fun[intro]:  
  assumes "$\texttt{integrable} \; M \; f$" "$f \in \texttt{borel\_measurable} \; (F \; t_0)$"
  shows "$\texttt{martingale} \; M \; F \; t_0 \; (\lambda \_. \; f)$"
  using assms sigma_finite_subalgebra.cond_exp_F_meas[OF _ assms(1), THEN AE_symmetric] 
  		borel_measurable_mono
  by (unfold_locales) blast+
\end{lstlisting}
}
\end{isalemma}

The statements below follow directly.

\begin{isacorollary}
{\small
\begin{lstlisting}[style=isabelle]
corollary (in sigma_finite_filtered_measure) martingale_zero[intro]: 
	"$\texttt{martingale} \; M \; F \; t_0 \; (\lambda \_ \; \_. \; 0)$" by fastforce

corollary (in finite_filtered_measure) martingale_const[intro]: 
	"$\texttt{martingale} \; M \; F \; t_0 \; (\lambda \_ \; \_. \; c)$" by fastforce
\end{lstlisting}
}
\end{isacorollary}

The stochastic process defined by $X_t = \mathbb{E}(f \;\vert\; F_t)$ for $f \in L^1(E)$ is also a martingale. This follows from the tower property of the conditional expectation.

\begin{isalemma}
{\small
\begin{lstlisting}[style=isabelle]
lemma (in sigma_finite_filtered_measure) martingale_cond_exp[intro]:  
  assumes "$\texttt{integrable} \; M \; f$"
  shows "$\texttt{martingale} \; M \; F \; t_0 \; (\lambda i. \; \texttt{cond\_exp} \; M \; (F \; i) \; f)$"
  using sigma_finite_subalgebra.borel_measurable_cond_exp' borel_measurable_cond_exp 
  by (unfold_locales) (auto intro: sigma_finite_subalgebra.cond_exp_nested_subalg[OF _ assms] 
  							simp add: subalgebra_F subalgebra)
\end{lstlisting}
}
\end{isalemma}

\section{First Consequences, Basic Operations and Sufficient Conditions}

First and foremost, we will discuss elementary properties of martingales, submartingales and supermartingales. Let $(X_t)_{t \in [t_0,\infty)}$ be a martingale with respect to the filtration $(F_t)_{t \in [t_0,\infty)}$. Using the martingale property and the characterization of the conditional expectation, we have the following lemma.

\begin{isalemma}
{\small
\begin{lstlisting}[style=isabelle]
lemma (in martingale) set_integral_eq:
  assumes "$A \in F \; i$" "$t_0 \le i$" "$i \le j$"
  shows "$\texttt{set\_lebesgue\_integral} \; M \; A \; (X \; i) = \texttt{set\_lebesgue\_integral} \; M \; A \; (X \; j)$"
\end{lstlisting}
}
\end{isalemma}

This lemma already shows us the intuition behind the definition of a martingale. Let $A$ be a set which is measurable at time $i$, i.e. some property of the process which we can inspect at time $i$. The average value that the process has on this set at time $i$ is equal to the average value it will have on the same set at a future time $j$. Essentially, this is the reason why martingales are employed for modeling fair games that incorporate an element of chance. Similarly, for sub- and supermartingales we have the following lemmas.

\begin{isalemma}
{\small
\begin{lstlisting}[style=isabelle]
lemma (in submartingale) set_integral_le:
  assumes "$A \in F \; i$" "$t_0 \le i$" "$i \le j$"
  shows "$\texttt{set\_lebesgue\_integral} \; M \; A \; (X \; i) \le \texttt{set\_lebesgue\_integral} \; M \; A \; (X \; j)$"
\end{lstlisting}
}
\end{isalemma}

\begin{isalemma}
{\small
\begin{lstlisting}[style=isabelle]
lemma (in supermartingale) set_integral_ge:
  assumes "$A \in F \; i$" "$t_0 \le i$" "$i \le j$"
  shows "$\texttt{set\_lebesgue\_integral} \; M \; A \; (X \; i) \ge \texttt{set\_lebesgue\_integral} \; M \; A \; (X \; j)$"
\end{lstlisting}
}
\end{isalemma}

In this case, the intuition is similar. The average value of a submartingale on a set which is measurable at time $i$ is less than or equal to the average value it will take on the same set at a future time $j$. The case for a supermartingale is analogous. Here is a simple example illustrating this concept.

\begin{example}
Consider a coin-tossing game, where the coin lands on heads with probability $p \in [0,1]$. Assume that the gambler wins a fixed amount $c > 0$ on a heads outcome and loses the same amount $c$ on a tails outcome. Let $(X_n)_{n \in \mathbb{N}}$ be a stochastic process, where $X_n$ denotes the gambler's fortune after the $n$-th coin toss. Then, we have the following three cases.
\begin{enumerate}
\item If $p = \frac{1}{2}$, it means the coin is fair and has an equal chance of landing heads or tails. In this case, the gambler, on average, neither wins nor loses money over time. The expected value of the gambler's fortune stays the same over time. Therefore, $(X_n)_{n \in \mathbb{N}}$ is a martingale. \\
\item If $p \le \frac{1}{2}$, it means the coin is biased in favor of tails. In this scenario, the gambler is more likely to lose money on each bet because the probability of getting heads is lower than $\frac{1}{2}$. Over time, the gambler's fortune decreases on average. Therefore, $(X_n)_{n \in \mathbb{N}}$ is a supermartingale.\\
\item If $p \ge \frac{1}{2}$, it means the coin is biased in favor of heads. In this case, the gambler is more likely to win money on each bet. Over time, the gambler's fortune tends to increase on average. Therefore, $(X_n)_{n \in \mathbb{N}}$ is a submartingale.
\end{enumerate}
\end{example}

\section{Discrete-Time Martingales}
