theory Filtration
imports "HOL-Probability.Probability" Sigma_Utils
begin

locale filtered_sigma_finite_measure = sigma_finite_measure M + filtration "space M" F for M F +
  assumes subalgebra: "\<And>i. subalgebra M (F i)"
      and sigma_finite: "\<And>i. sigma_finite_measure (restr_to_subalg M (F i))"

definition natural_filtration :: "'a measure \<Rightarrow> 's measure \<Rightarrow> ('t \<Rightarrow> 'a \<Rightarrow> 's) \<Rightarrow> 't :: {second_countable_topology, linorder_topology} \<Rightarrow> 'a measure" where
  "natural_filtration M N Y = restr_to_subalg M (\<lambda>t. sigma (space M) N {Y i | i A. i \<le> t})"

lemma [simp]:
  shows sets_natural_filtration: "sets (natural_filtration M N Y t) = sigma_sets (space M) (\<Union>i \<le> t. {Y i -` A \<inter> space M | A. A \<in> N})" 
    and space_natural_filtration: "space (natural_filtration M N Y t) = space M" unfolding natural_filtration_def by (auto intro!: arg_cong[of _ _ "\<lambda>x. sigma_sets (space M) x"])

interpretation natural_filtration: filtration "space M" "natural_filtration M N Y"
proof (unfold_locales, goal_cases)
  case (1 i)
  then show ?case by (simp add: natural_filtration_def)
next
  case (2 i j)
  have "{Y ia |ia. ia \<le> i} \<subseteq> {Y ia |ia. ia \<le> j}" using 2 by force
  hence "(\<Union>f\<in>{Y ia |ia. ia \<le> i}. {f -` A \<inter> space M |A. A \<in> sets N}) \<subseteq> (\<Union>f\<in>{Y ia |ia. ia \<le> j}. {f -` A \<inter> space M |A. A \<in> sets N})" by blast
  thus ?case unfolding natural_filtration_def sets_sigma_gen by (rule sigma_sets_subseteq)
qed

sublocale filtered_sigma_finite_measure \<subseteq> sigma_finite_subalgebra M "F i" sorry

end